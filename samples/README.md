# AST Builder å¼€å‘æ ·æœ¬

è¿™ä¸ªæ–‡ä»¶å¤¹åŒ…å«ç”¨äºå¼€å‘å’Œæµ‹è¯• ast-builder ç³»ç»Ÿçš„ç¤ºä¾‹ä»£ç ã€‚

## å¼€å‘æµç¨‹

ä½¿ç”¨ä»¥ä¸‹è¿­ä»£æµç¨‹æ¥å®Œå–„ ast-builder ç³»ç»Ÿï¼š

### 1. åˆ›å»ºç¤ºä¾‹ä»£ç 
åœ¨ `samples/` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºåŒ…å«æ–°è¯­æ³•ç‰¹æ€§çš„ TypeScript ç¤ºä¾‹æ–‡ä»¶ï¼š
```bash
# ä¾‹å¦‚åˆ›å»º samples/basic-expressions.ts
```

### 2. ç”Ÿæˆ AST JSON
ä½¿ç”¨ CLI å·¥å…·è§£æç¤ºä¾‹ä»£ç ç”Ÿæˆ ASTï¼š
```bash
bun run cli/index.ts parse samples/basic-expressions.ts -a samples/basic-expressions.ast.json -O
# è¿™ä¼šç”Ÿæˆ samples/basic-expressions.ast.json
```

### 3. å°è¯•ä»£ç ç”Ÿæˆ
ä½¿ç”¨ stringify å‘½ä»¤æµ‹è¯•ä»£ç ç”Ÿæˆï¼Œè¯†åˆ«ç¼ºå¤±çš„èŠ‚ç‚¹ç±»å‹ï¼š
```bash
bun run cli/index.ts stringify samples/basic-expressions.ast.json
# è¾“å‡ºä¼šæ˜¾ç¤º "Unsupported node type: XXX" é”™è¯¯
```

### 4. æ£€æŸ¥ AST ç»“æ„
ä½¿ç”¨ tree å‘½ä»¤æŸ¥çœ‹ç‰¹å®šèŠ‚ç‚¹çš„ AST ç»“æ„ï¼š
```bash
bun run cli/index.ts tree samples/basic-expressions.ast.json -n some-node-id
# è¿™å¸®åŠ©ç†è§£å¦‚ä½•å®ç°ç¼ºå¤±çš„èŠ‚ç‚¹ç±»å‹
```

### 5. å®ç°ç¼ºå¤±çš„èŠ‚ç‚¹ç±»å‹
åœ¨ `src/ast-builder/nodes/` ä¸­å®ç°æ–°çš„èŠ‚ç‚¹æ„å»ºå™¨ï¼š
```typescript
// ä¾‹å¦‚ src/ast-builder/nodes/binary-expression.ts
export const createBinaryExpression: NodeBuilderFn<ts.BinaryExpression> = (
  sourceFile: SourceFileAST,
  node: ASTNode,
  createNode: CreateNodeFn<ts.Node>
): ts.BinaryExpression => {
  // å®ç°é€»è¾‘
};
```

### 6. æ›´æ–°ä¸»ç´¢å¼•
åœ¨ `src/ast-builder/index.ts` çš„ switch è¯­å¥ä¸­æ·»åŠ æ–°çš„ caseï¼š
```typescript
case ts.SyntaxKind.BinaryExpression:
  return createBinaryExpression(sourceFile, node, createNode);
```

### 7. æµ‹è¯•éªŒè¯
é‡æ–°è¿è¡Œ stringify å‘½ä»¤éªŒè¯å®ç°ï¼š
```bash
bun run cli/index.ts stringify samples/basic-expressions.ast.json
# åº”è¯¥ç”Ÿæˆæ­£ç¡®çš„ TypeScript ä»£ç 
```

## ç¤ºä¾‹æ–‡ä»¶ç»„ç»‡

æŒ‰åŠŸèƒ½ç»„ç»‡ç¤ºä¾‹æ–‡ä»¶ï¼š

- `basic-syntax.ts` - åŸºç¡€è¯­æ³•ï¼šå˜é‡ã€å‡½æ•°ã€ç±»å‹
- `expressions.ts` - è¡¨è¾¾å¼ï¼šäºŒå…ƒè¿ç®—ã€å±æ€§è®¿é—®ã€è°ƒç”¨è¡¨è¾¾å¼
- `async-await.ts` - å¼‚æ­¥è¯­æ³•ï¼šasync/awaitã€Promise
- `classes.ts` - ç±»å£°æ˜ï¼šæ„é€ å‡½æ•°ã€æ–¹æ³•ã€å±æ€§
- `interfaces.ts` - æ¥å£å’Œç±»å‹å®šä¹‰
- `advanced.ts` - é«˜çº§ç‰¹æ€§ï¼šæ³›å‹ã€è£…é¥°å™¨ã€æ¨¡å—

## ä¸´æ—¶æ–‡ä»¶

`*.ast.json` æ–‡ä»¶æ˜¯ä¸´æ—¶ç”Ÿæˆçš„ï¼Œå·²åœ¨ `.gitignore` ä¸­æ’é™¤ã€‚

## æ³¨æ„äº‹é¡¹

1. æ¯æ¬¡æ·»åŠ æ–°çš„ç¤ºä¾‹ä»£ç æ—¶ï¼Œå…ˆç¡®ä¿ç°æœ‰çš„èŠ‚ç‚¹ç±»å‹å·¥ä½œæ­£å¸¸
2. ä½¿ç”¨ tree å‘½ä»¤æ·±å…¥ç†è§£å¤æ‚èŠ‚ç‚¹çš„ç»“æ„
3. å®ç°èŠ‚ç‚¹æ„å»ºå™¨æ—¶ï¼Œéµå¾ªç°æœ‰çš„ `CreateNodeFn<T>` ä¾èµ–æ³¨å…¥æ¨¡å¼
4. æµ‹è¯•æ—¶æ³¨æ„æ£€æŸ¥ç”Ÿæˆçš„ä»£ç æ˜¯å¦è¯­æ³•æ­£ç¡®ä¸”è¯­ä¹‰ç­‰ä»·
5. **ä½¿ç”¨ `bun test` ç»™æ¯”è¾ƒå¤æ‚çš„ä»£ç é€»è¾‘åŠ å•æµ‹è¿›è¡ŒéªŒè¯**ï¼Œä»¥æ›¿ä»£å†™éšæœºçš„æµ‹è¯•è„šæœ¬
6. **å‚è€ƒ TypeScript package æä¾›çš„ `typescript.d.ts`**ï¼Œä»ä¸­æœç´¢å¯èƒ½ä¼šç”¨åˆ°çš„å‡½æ•°å’Œç±»å‹å®šä¹‰

## å®ç°æŠ€å·§

### Template å­—ç¬¦ä¸²å¤„ç†
åœ¨å®ç°æ¨¡æ¿å­—ç¬¦ä¸²ç›¸å…³èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦æ³¨æ„ï¼š
- **TemplateHead** åŒ…å« `` `Hello, ${` ``ï¼ˆåŒ…å«å¼€å§‹åå¼•å·å’Œ `${`ï¼‰
- **TemplateTail** åŒ…å« `}!` ``ï¼ˆåŒ…å« `}` å’Œç»“æŸåå¼•å·ï¼‰
- **TemplateMiddle** åŒ…å« `}...${`ï¼ˆåŒ…å«å‰åçš„åˆ†éš”ç¬¦ï¼‰

AST åœ¨ç”Ÿæˆæ—¶ï¼Œtext åŒ…å«äº† `${`ã€`}` è¿™äº›å­—ç¬¦ã€‚é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦åŒºæ®µï¼Œå…¶ä»–çš„éƒ½å¤©ç„¶åŒ…å«äº† `${` åç¼€ï¼›é™¤äº†ç¬¬ä¸€ä¸ªåŒºæ®µï¼Œå…¶ä»–éƒ½åŒ…å«äº† `}` å‰ç¼€ã€‚

## æ¨èçš„æµ‹è¯•æµç¨‹

### å®Œæ•´æµ‹è¯•å·¥ä½œæµ

1. **åˆ›å»ºæµ‹è¯•æ–‡ä»¶** - åœ¨ `samples/` ç›®å½•ä¸‹åˆ›å»ºåŒ…å«ç›®æ ‡è¯­æ³•çš„ TypeScript æ–‡ä»¶
2. **è§£ææµ‹è¯•** - è¿è¡Œ `bun run cli/index.ts parse <file>.ts` æŸ¥çœ‹ AST ç»“æ„
3. **å®ç°èŠ‚ç‚¹** - æ ¹æ®è§£æç»“æœåœ¨ `src/ast-builder/nodes/` ä¸‹å®ç°ç¼ºå¤±çš„èŠ‚ç‚¹ç±»å‹
4. **æ³¨å†ŒèŠ‚ç‚¹** - åœ¨ `src/ast-builder/index.ts` ä¸­å¯¼å…¥å¹¶æ·»åŠ  case åˆ†æ”¯
5. **ç”Ÿæˆæµ‹è¯•** - è¿è¡Œ `bun run cli/index.ts stringify <parsed>.json` ç”Ÿæˆä»£ç 
6. **å¯¹æ¯”éªŒè¯** - ä½¿ç”¨ `diff` å‘½ä»¤æ¯”è¾ƒåŸå§‹æ–‡ä»¶ä¸ç”Ÿæˆæ–‡ä»¶
7. **ä¿®å¤é—®é¢˜** - æ ¹æ®å·®å¼‚è°ƒæ•´èŠ‚ç‚¹å®ç°é€»è¾‘
8. **æäº¤ä»£ç ** - æ›´æ–°æ–‡æ¡£å¹¶æäº¤æ”¹è¿›

### è°ƒè¯•æŠ€å·§

**æŸ¥çœ‹èŠ‚ç‚¹ç»“æ„ï¼š**
```bash
# æŸ¥çœ‹ç‰¹å®šèŠ‚ç‚¹ç±»å‹
bun run cli/index.ts parse file.ts | grep -A 5 "kind.*XXX"

# æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
bun run cli/index.ts parse file.ts | grep -A 10 '"nodeId"'
```

**å¸¸è§é—®é¢˜æ’æŸ¥ï¼š**
- å¯¼å…¥/å±•å¼€è¯­æ³•é—®é¢˜ï¼šæ£€æŸ¥ SyntaxList çš„é€’å½’å¤„ç†
- æ¨¡æ¿å­—ç¬¦ä¸²é—®é¢˜ï¼šæ³¨æ„ TemplateSpan å’Œ token çš„å¤„ç†é¡ºåº
- è§£æ„èµ‹å€¼é—®é¢˜ï¼šç¡®ä¿ ObjectBindingPattern å’Œ BindingElement çš„æ­£ç¡®æ˜ å°„
- ç±»å‹æ³¨è§£é—®é¢˜ï¼šæ£€æŸ¥ TypeReference å’Œå„ç§ç±»å‹å…³é”®å­—çš„æ”¯æŒ

## ğŸ¯ é«˜çº§è°ƒè¯•ç»éªŒæ•™è®­

### åˆ†æ²»è°ƒè¯•æ³• (Divide & Conquer Debugging)

å½“é¢å¯¹å¤æ‚çš„ AST å¤„ç†é”™è¯¯æ—¶ï¼Œé‡‡ç”¨åˆ†æ²»æ³•å¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜ï¼š

#### 1. é”™è¯¯ç°è±¡è¯†åˆ«
```bash
# å½“çœ‹åˆ°ç±»ä¼¼é”™è¯¯æ—¶ï¼š
# Error: Debug Failure. Unhandled SyntaxKind: Unknown.
# è¿™é€šå¸¸æ„å‘³ç€æŸä¸ªèŠ‚ç‚¹çš„ SyntaxKind æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®
```

#### 2. åˆ†æ²»è°ƒè¯•è„šæœ¬
åˆ›å»ºè°ƒè¯•è„šæœ¬é€ä¸ªæµ‹è¯•ASTå­æ ‘ï¼š
```typescript
// debug-subtree.ts ç¤ºä¾‹
const topLevelNodes = [
  { id: 'node1', type: 'TypeAliasDeclaration', name: 'NonNullable' },
  { id: 'node2', type: 'ClassDeclaration', name: 'Circle' }
];

for (const node of topLevelNodes) {
  try {
    // åˆ›å»ºåªåŒ…å«å½“å‰èŠ‚ç‚¹çš„å­æ ‘AST
    const subtreeAST = createSubtreeAST(node.id);
    const result = stringify(subtreeAST);
    console.log(`âœ… ${node.name} æˆåŠŸ`);
  } catch (error) {
    console.log(`âŒ ${node.name} å¤±è´¥: ${error.message}`);
  }
}
```

#### 3. æ¸è¿›å¼é—®é¢˜å®šä½
```bash
# Step 1: å®šä½å‡ºé”™çš„é¡¶çº§èŠ‚ç‚¹
bun debug-subtree.ts

# Step 2: åˆ†æå‡ºé”™èŠ‚ç‚¹çš„ç»“æ„  
bun run cli tree samples/file.ast.json -n problemNodeId

# Step 3: åˆ›å»ºæœ€ç®€å¤ç°æ¡ˆä¾‹
echo "class Circle { constructor(private radius: number) {} }" > simple-test.ts
bun run cli parse simple-test.ts
```

### ç»éªŒæ•™è®­æ€»ç»“

#### âœ… æˆåŠŸç»éªŒ
1. **ä»”ç»†è§‚å¯Ÿï¼Œå¤§èƒ†å‡è®¾ï¼Œè®¤çœŸæ±‚è¯**
   - è§‚å¯Ÿï¼šé”™è¯¯å‘ç”Ÿåœ¨å‚æ•°å¤„ç†é˜¶æ®µ
   - å‡è®¾ï¼šé—®é¢˜å‡ºåœ¨æ„é€ å‡½æ•°å‚æ•°çš„ä¿®é¥°ç¬¦å¤„ç†
   - æ±‚è¯ï¼šåˆ›å»ºç®€åŒ–æµ‹è¯•ç”¨ä¾‹éªŒè¯å‡è®¾

2. **åˆ†æ²»æ³•è°ƒè¯•çš„å¨åŠ›**
   - å°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¯ç®¡ç†çš„å°é—®é¢˜
   - ç³»ç»Ÿæ€§åœ°æ’é™¤å¯èƒ½æ€§ï¼Œå¿«é€Ÿå®šä½æ ¹å› 
   - é¿å…ç›²ç›®çŒœæµ‹ï¼Œæé«˜è°ƒè¯•æ•ˆç‡

3. **æ¸è¿›å¼æµ‹è¯•ç­–ç•¥**
   - å…ˆæµ‹è¯•ç®€å•æƒ…å†µï¼Œå†æµ‹è¯•å¤æ‚æƒ…å†µ
   - ç¡®ä¿ä¿®å¤ä¸ä¼šå¼•å…¥æ–°é—®é¢˜
   - å»ºç«‹å®Œæ•´çš„å›å½’æµ‹è¯•æœºåˆ¶

#### âš ï¸ é¿å…çš„é™·é˜±
1. **å¿½è§†èŠ‚ç‚¹ç»“æ„çš„å¤æ‚æ€§**
   - æ„é€ å‡½æ•°å‚æ•°çš„ `private` ä¿®é¥°ç¬¦è¢«åŒ…è£…åœ¨ `SyntaxList` ä¸­
   - ä¸èƒ½å‡è®¾ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹å°±æ˜¯å‚æ•°å
   - éœ€è¦åŠ¨æ€æ£€æµ‹å’Œå¤„ç†ä¸åŒçš„èŠ‚ç‚¹ç»“æ„

2. **é”™è¯¯çš„è°ƒè¯•æ–¹å¼**
   - âŒ ç›´æ¥ä¿®æ”¹å¤æ‚æ–‡ä»¶è¯•å›¾è§£å†³é—®é¢˜
   - âŒ ç›²ç›®æ·»åŠ  console.log è€Œä¸ç³»ç»ŸåŒ–è°ƒè¯•
   - âŒ ä¿ç•™å¤§é‡ä¸´æ—¶è°ƒè¯•è„šæœ¬æ±¡æŸ“ä»£ç åº“
   - âœ… åˆ›å»ºæœ€ç®€å¤ç°æ¡ˆä¾‹ï¼Œä¸“æ³¨æ ¸å¿ƒé—®é¢˜
   - âœ… ä½¿ç”¨ä¸´æ—¶è°ƒè¯•è„šæœ¬ï¼Œç”¨å®Œå³åˆ 

3. **å¿½è§†è¾¹ç•Œæƒ…å†µ**
   - å¤„ç†ä¿®é¥°ç¬¦æ—¶è¦è€ƒè™‘ç©ºä¿®é¥°ç¬¦åˆ—è¡¨çš„æƒ…å†µ
   - ç¡®ä¿ `modifiers.length > 0 ? modifiers : undefined` çš„æ­£ç¡®å¤„ç†

#### ğŸ”§ å®ç”¨è°ƒè¯•å·¥å…·æ¨¡æ¿

è°ƒè¯•è„šæœ¬åº”è¯¥æ˜¯**ä¸´æ—¶å·¥å…·** - å†™å®Œç”¨å®Œå°±åˆ æ‰ï¼Œä¸éœ€è¦ä¿ç•™ã€‚é‡è¦çš„æ˜¯æŒæ¡åˆ›å»ºè°ƒè¯•è„šæœ¬çš„æ€è·¯å’Œæ¨¡æ¿ï¼š

```bash
# ä¸´æ—¶åˆ†æ²»è°ƒè¯•è„šæœ¬æ¨¡æ¿ï¼ˆç”¨å®Œå³åˆ ï¼‰
cat > debug-temp.ts << 'EOF'
#!/usr/bin/env bun
import { execSync } from 'child_process';
import { readFileSync, writeFileSync } from 'fs';

const nodes = [
  // ä» CLI children å‘½ä»¤è·å–éœ€è¦æµ‹è¯•çš„èŠ‚ç‚¹åˆ—è¡¨
];

for (const node of nodes) {
  try {
    // æ ¹æ®å…·ä½“é—®é¢˜å®šåˆ¶æµ‹è¯•é€»è¾‘
    const result = testSpecificNode(node);
    console.log(`âœ… ${node.name} æˆåŠŸ`);
  } catch (error) {
    console.log(`âŒ ${node.name}: ${error.message}`);
  }
}
EOF

# ä½¿ç”¨å®Œæ¯•ååˆ é™¤
bun debug-temp.ts && rm debug-temp.ts
```

**è°ƒè¯•è„šæœ¬çš„ç”Ÿå‘½å‘¨æœŸ:**
1. ğŸ”¨ **å¿«é€Ÿåˆ›å»º** - æ ¹æ®å…·ä½“é—®é¢˜ä¸´æ—¶ç¼–å†™
2. ğŸ¯ **ä¸“æ³¨ä½¿ç”¨** - å®šä½é—®é¢˜æ ¹æº
3. ğŸ—‘ï¸ **ç«‹å³åˆ é™¤** - é¿å…ä»£ç åº“æ±¡æŸ“

> **æ ¸å¿ƒåŸåˆ™**: è°ƒè¯•è„šæœ¬æ˜¯æ¶ˆè€—å“ï¼Œæ–¹æ³•è®ºå’Œç»éªŒæ˜¯èµ„äº§ã€‚

#### ğŸ“‹ é—®é¢˜è§£å†³æ£€æŸ¥æ¸…å•

- [ ] ä½¿ç”¨åˆ†æ²»æ³•å®šä½å…·ä½“å‡ºé”™çš„èŠ‚ç‚¹
- [ ] åˆ›å»ºæœ€ç®€å¤ç°æ¡ˆä¾‹
- [ ] åˆ†æèŠ‚ç‚¹çš„å®Œæ•´å­æ ‘ç»“æ„
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰è¢«å¿½ç•¥çš„åŒ…è£…èŠ‚ç‚¹ï¼ˆå¦‚ SyntaxListï¼‰
- [ ] ç¡®ä¿æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æœ‰æ­£ç¡®çš„ SyntaxKind
- [ ] éªŒè¯ä¿®å¤ä¸å½±å“å…¶ä»–åŠŸèƒ½
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œè¿›åº¦æ–‡ä»¶
- [ ] æäº¤ä»£ç å¹¶æ¸…ç†ä¸´æ—¶è°ƒè¯•æ–‡ä»¶

#### ğŸ’¡ æœ€ä½³å®è·µ

1. **é¢„é˜²ä¸ºä¸»**: åœ¨å®ç°æ–°èŠ‚ç‚¹æ—¶ï¼Œè€ƒè™‘æ‰€æœ‰å¯èƒ½çš„å­èŠ‚ç‚¹ç»„åˆ
2. **æ–‡æ¡£é©±åŠ¨**: åŠæ—¶æ›´æ–° PROGRESS.mdï¼Œè®°å½•æ”¯æŒçš„è¯­æ³•ç‰¹æ€§
3. **æµ‹è¯•ä¼˜å…ˆ**: ä¸ºå¤æ‚é€»è¾‘ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œé¿å…ä¾èµ–æ‰‹å·¥éªŒè¯
4. **ä¸´æ—¶å·¥å…·åŒ–è°ƒè¯•**: å¿«é€Ÿç¼–å†™ä¸´æ—¶è°ƒè¯•è„šæœ¬å®šä½é—®é¢˜ï¼Œç”¨å®Œå³åˆ 
5. **ä¿æŒä»£ç åº“æ•´æ´**: ä¸ä¿ç•™ä¸´æ—¶è°ƒè¯•æ–‡ä»¶ï¼Œé‡è§†æ–¹æ³•è®ºä¼ æ‰¿

> **æ ¸å¿ƒç†å¿µ**: é€šè¿‡ç³»ç»ŸåŒ–çš„æ–¹æ³•è®ºï¼Œå°†å¤æ‚çš„ AST è°ƒè¯•é—®é¢˜è½¬åŒ–ä¸ºå¯ç®¡ç†ã€å¯é‡ç°çš„å°é—®é¢˜ã€‚è°ƒè¯•è„šæœ¬æ˜¯ä¸´æ—¶å·¥å…·ï¼Œæ–¹æ³•è®ºå’Œç»éªŒæ‰æ˜¯é•¿æœŸèµ„äº§ã€‚
```
