# 重构后的项目结构设计

## 目标架构

```
arbores/
├── src/
│   ├── api/                    # Node.js API 层
│   │   ├── index.ts           # 统一入口和便捷函数
│   │   ├── parser.ts          # 解析 API
│   │   ├── query.ts           # 查询 API
│   │   ├── stringifier.ts     # 代码生成 API
│   │   └── format.ts          # 格式化 API
│   ├── core/                   # 核心业务逻辑
│   │   ├── parser.ts          # AST 解析核心 (现有)
│   │   ├── stringifier/       # 代码生成核心 (现有)
│   │   ├── query.ts           # 查询逻辑核心 (新增)
│   │   └── format.ts          # 格式化逻辑核心 (新增)
│   ├── types.ts               # 类型定义 (现有)
│   ├── utils.ts               # 工具函数 (现有)
│   └── errors.ts              # 错误处理 (新增)
├── cli/                       # CLI 接口层
│   ├── index.ts               # CLI 入口 (现有)
│   ├── commands/              # CLI 命令模块
│   │   ├── parse.ts           # 解析命令 (重构)
│   │   ├── query/             # 查询命令组
│   │   │   ├── roots.ts       # 根节点查询
│   │   │   ├── children.ts    # 子节点查询
│   │   │   ├── parents.ts     # 父节点查询
│   │   │   ├── tree.ts        # 树形显示
│   │   │   └── node.ts        # 节点详情
│   │   └── stringify.ts       # 代码生成命令 (重构)
│   ├── adapters/              # CLI 适配器
│   │   ├── parser.ts          # 解析适配器
│   │   ├── query.ts           # 查询适配器
│   │   └── stringifier.ts     # 代码生成适配器
│   └── utils/                 # CLI 工具函数
│       ├── formatter.ts       # CLI 格式化工具
│       ├── error-handler.ts   # CLI 错误处理
│       └── table.ts           # 表格显示工具
├── tests/                     # 测试文件
│   ├── api/                   # API 测试
│   │   ├── parser.test.ts
│   │   ├── query.test.ts
│   │   ├── stringifier.test.ts
│   │   └── format.test.ts
│   ├── core/                  # 核心逻辑测试
│   ├── cli/                   # CLI 测试
│   ├── integration/           # 集成测试
│   └── fixtures/              # 测试数据
├── http/                      # HTTP API 层 (未来)
├── docs/                      # 文档
├── samples/                   # 示例文件
└── scripts/                   # 构建脚本
```

## 重构计划

### 阶段 1: 核心 API 层建设

1. **创建 API 模块结构**
   - `src/api/` 目录和基础文件
   - 定义统一的接口规范
   - 实现基础的 ParserAPI

2. **抽象核心逻辑**
   - 将现有 CLI 逻辑抽取到 `src/core/`
   - 创建 QueryCore, FormatCore 等模块
   - 统一错误处理机制

3. **实现第一个完整 API**
   - 完成 ParserAPI 的实现和测试
   - 验证 API 设计的可行性
   - 建立测试框架和 CI

### 阶段 2: CLI 重构

1. **拆分查询命令**
   - 将 `cli/query.ts` 拆分为独立命令文件
   - 创建 `cli/commands/query/` 目录结构
   - 每个查询功能独立文件

2. **创建 CLI 适配器**
   - CLI 命令调用 API 层而不是直接调用核心逻辑
   - 统一 CLI 的错误处理和格式化
   - 保持现有 CLI 接口不变

3. **改进 CLI 工具**
   - 抽取表格格式化到独立工具模块
   - 统一 CLI 帮助信息格式
   - 改进错误提示和用户体验

### 阶段 3: 测试完善

1. **API 单元测试**
   - 每个 API 模块的完整测试覆盖
   - Mock 文件系统和外部依赖
   - 边界条件和错误场景测试

2. **集成测试**
   - 真实文件的端到端测试
   - CLI 命令的自动化测试
   - 性能基准测试

3. **测试基础设施**
   - 测试数据管理
   - CI/CD 集成
   - 测试覆盖率报告

## 迁移策略

### 向后兼容

- CLI 接口保持不变，用户无感知迁移
- 现有的 AST 文件格式继续支持
- 逐步迁移，每个阶段都可以独立发布

### 渐进式重构

1. **先建设后迁移**：先建设新的 API 层，再迁移现有功能
2. **功能对等**：确保新实现与现有功能完全对等
3. **充分测试**：每个迁移步骤都有完整的测试验证

### 风险控制

- 保持现有代码可用，新旧代码并行存在
- 小步快跑，每次只重构一个模块
- 完整的回退方案，出问题可以快速回滚

## 开发流程

### 1. API 优先设计

- 先设计接口，再实现功能
- 接口设计评审和讨论
- 类型定义先行，确保类型安全

### 2. 测试驱动开发

- 先写测试用例，再实现功能
- 每个 API 都有完整的测试套件
- 持续集成确保代码质量

### 3. 文档同步更新

- API 文档自动生成
- 使用示例和最佳实践
- 迁移指南和变更日志

## 预期收益

### 开发效率

- 统一的 API 接口，减少重复开发
- 模块化架构，便于并行开发
- 完善的测试，减少调试时间

### 用户体验

- 多种接口选择（CLI, Node.js API, 未来的 HTTP API）
- 一致的数据格式和错误处理
- 更好的性能和稳定性

### 项目可维护性

- 清晰的分层架构，职责明确
- 完整的测试覆盖，重构安全
- 标准化的开发流程

---

*创建时间：2025年7月20日*  
*版本：v1.0*  
*状态：设计阶段*
